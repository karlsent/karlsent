# Продвинутый PHP Telegram Бот с AI интеграцией

Этот проект представляет собой PHP Telegram бота, построенного на принципах MVC, с интеграцией AI моделей (OpenAI, Gemini) для генерации ответов. Бот способен работать в личных сообщениях, группах и каналах, поддерживать контекст беседы, реагировать на упоминания и ключевые слова, а также проактивно участвовать в диалогах.

## Основные возможности

*   **AI-интеграция**: Поддержка нескольких AI провайдеров (OpenAI, Gemini) с возможностью переключения.
*   **Контекстно-зависимые ответы**: Хранение истории сообщений для генерации релевантных ответов.
*   **Работа в чатах**: Обработка сообщений в личных чатах, группах и каналах.
*   **Гибкая реакция**: Ответы на упоминания бота, ключевые слова и прямые ответы на сообщения бота.
*   **Проактивное вовлечение**: Бот может вступать в диалог в группе, если его долго не упоминали.
*   **Настраиваемые роли AI**: Возможность задавать системные роли для AI для каждого чата индивидуально.
*   **Логирование**: Подробное логирование действий и ошибок.
*   **Статистика токенов**: Сбор статистики использования токенов AI для каждого чата.
*   **Безбазный**: Не требует базы данных, хранит историю и настройки в файлах.
*   **Веб-хук**: Работает через Telegram Bot API с использованием веб-хуков.

## Структура проекта

```
/app
|-- /Controllers     # Контроллеры (логика обработки запросов)
|-- /Interfaces      # Интерфейсы (например, для AI моделей)
|-- /Models          # Модели (взаимодействие с AI API)
|-- /Services        # Сервисы (вспомогательная логика: Telegram API, история, роли, логи, токены)
/config
|-- config.php       # Основной конфигурационный файл (требуется создать из config.example.php)
/history             # Директория для хранения истории сообщений чатов (создается автоматически)
/logs                # Директория для лог-файлов (создается автоматически)
/public
|-- index.php        # Точка входа, простой роутер
/storage
|-- /chat_roles.json # Файл для хранения кастомных ролей AI для чатов (создается автоматически)
|-- /token_usage     # Директория для статистики использования токенов (создается автоматически)
/vendor              # Зависимости Composer (устанавливаются командой composer install)
.gitignore           # Файл для исключения файлов и папок из Git
composer.json        # Описание проекта и его зависимостей для Composer
README.md            # Этот файл
```

## Требования

*   PHP >= 8.1
*   Composer
*   Веб-сервер (например, Nginx, Apache) с поддержкой HTTPS (для веб-хука Telegram)
*   Аккаунты и API ключи для:
    *   Telegram Bot API
    *   Gemini API (Google)
    *   OpenAI API (опционально, если используется)

## Установка и настройка

1.  **Клонируйте репозиторий (если он уже на GitHub):**
    ```bash
    git clone https://github.com/your-username/your-repository-name.git
    cd your-repository-name
    ```
    Или просто скачайте файлы проекта в нужную директорию.

2.  **Установите зависимости:**
    В корневой директории проекта выполните команду:
    ```bash
    composer install
    ```
    Эта команда установит `guzzlehttp/guzzle` и другие необходимые пакеты.

3.  **Настройте конфигурационный файл:**
    *   Скопируйте `config/config.example.php` (если он будет создан) в `config/config.php`.
        Если `config.example.php` нет, создайте `config/config.php` вручную.
    *   Откройте `config/config.php` и заполните все необходимые параметры:
        *   `telegram_bot_token`: Ваш токен Telegram бота.
        *   `telegram_bot_username`: Имя пользователя вашего бота (без `@`).
        *   `gemini_api_key`: Ваш API ключ для Gemini.
        *   `openai_api_key`: Ваш API ключ для OpenAI (если используется).
        *   `active_ai_provider`: Установите `'openai'` или `'gemini'`.
        *   `webhook_url`: **Очень важно!** Укажите полный HTTPS URL вашего `public/index.php`. Например: `https://yourdomain.com/path/to/bot/public/index.php`.
        *   Остальные параметры (лимиты истории, пути к хранилищам, роли по умолчанию и т.д.) можно оставить по умолчанию или настроить по желанию.

4.  **Настройте права доступа:**
    Убедитесь, что веб-сервер имеет права на запись в директории:
    *   `logs/`
    *   `history/`
    *   `storage/` (и ее поддиректории `token_usage/`)
    Если эти директории не создаются автоматически, создайте их вручную и установите права.

5.  **Зарегистрируйте веб-хук:**
    Откройте в браузере URL, который вы указали в `webhook_url`, добавив к нему `/set-webhook`.
    Например: `https://yourdomain.com/path/to/bot/public/index.php/set-webhook`
    Вы должны увидеть сообщение об успешной установке веб-хука.

    *Примечание: Некоторые веб-серверы могут требовать настройки для обработки таких URL (например, через `.htaccess` для Apache или `try_files` для Nginx, чтобы все запросы к `index.php/...` правильно маршрутизировались на `index.php`). Простой вариант - чтобы `index.php` принимал параметр, например `?action=set-webhook`.*

6.  **Настройки бота в Telegram (через @BotFather):**
    *   Если вы хотите, чтобы бот читал все сообщения в группах (а не только упоминания и команды), отключите режим приватности для групп:
        *   Откройте диалог с `@BotFather`.
        *   Отправьте `/mybots`, выберите вашего бота.
        *   Нажмите "Bot Settings" -> "Group Privacy" -> "Turn off".

## Конфигурация (`config/config.php`)

Основные параметры для настройки:

*   `telegram_bot_token`, `telegram_bot_username`: Данные вашего Telegram бота.
*   `gemini_api_key`, `gemini_api_url`: Настройки для Gemini API.
*   `openai_api_key`, `openai_api_url`, `openai_model`: Настройки для OpenAI API.
*   `active_ai_provider`: Выбор активного AI ('gemini' или 'openai').
*   `default_ai_role`: Системная роль AI по умолчанию.
*   `chat_roles_storage_path`: Путь к файлу с кастомными ролями для чатов.
*   `monitored_keywords`: Массив ключевых слов, на которые бот будет реагировать.
*   `message_history_limit`: Количество сообщений, хранимых в истории для контекста.
*   `message_history_storage_path`: Путь к директории для файлов истории.
*   `webhook_url`: URL для установки веб-хука Telegram.
*   `log_path`, `debug_mode`: Настройки логирования.
*   `enable_proactive_engagement`, `proactive_engagement_message_threshold`, `proactive_engagement_system_role`, `proactive_engagement_user_prompt_template`: Настройки для проактивного вовлечения бота.
*   `bot_history_prefix`: Префикс для сообщений бота в файлах истории.
*   `token_usage_storage_path`: Путь для статистики использования токенов.

## Использование

После успешной настройки и установки веб-хука, бот будет автоматически обрабатывать входящие сообщения в тех чатах, куда он добавлен:

*   **Личные сообщения**: Бот будет отвечать на все текстовые сообщения.
*   **Группы/Супергруппы**:
    *   Бот ответит, если его упомянут (`@имя_бота`).
    *   Бот ответит, если в сообщении встретится одно из `monitored_keywords`.
    *   Бот ответит, если сообщение является ответом на предыдущее сообщение бота.
    *   Если включено проактивное вовлечение, бот может сам написать в группу, если в ней было много сообщений без его участия.
*   **Каналы**: Бот будет слушать посты, но отвечать на них по умолчанию не будет (можно настроить, если нужно реагировать на упоминания в каналах, изменив логику в `TelegramController`).

Для изменения роли AI для конкретного чата, необходимо вручную отредактировать файл, указанный в `chat_roles_storage_path` (по умолчанию `storage/chat_roles.json`), добавив ID чата и текст роли.

## Возможные проблемы и их решения

*   **Ошибки GuzzleHttp\Client не найден**: Убедитесь, что вы выполнили `composer install`. Если ошибка в IDE, попробуйте перезапустить IDE или обновить её для корректной индексации папки `vendor/`.
*   **Веб-хук не устанавливается / не приходят обновления**:
    *   Проверьте правильность `webhook_url` в `config.php` (должен быть HTTPS).
    *   Убедитесь, что ваш сервер доступен извне и настроен для обработки HTTPS.
    *   Проверьте логи веб-сервера и логи бота (`logs/bot.log`) на наличие ошибок.
    *   Убедитесь, что Telegram может достучаться до вашего URL (нет файрвола, блокирующего запросы от Telegram).
*   **Бот не отвечает в группах**: Проверьте настройки приватности бота в `@BotFather`.
*   **Ошибки от AI API (Gemini/OpenAI)**: Проверьте API ключи, доступность сервиса для вашего региона, правильность указанных моделей в `config.php`.

---

Этот README файл должен дать хорошее представление о вашем проекте. Вы можете его дополнить или изменить по своему усмотрению. 